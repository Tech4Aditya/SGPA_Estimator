<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semester Grade Point Average (SGPA) Calculator</title>
    <!-- FAVICON: Using the JIIT logo image -->
    <link rel="icon" type="image/png" href="https://github.com/Tech4Aditya/Virtual-Physics-Lab/blob/main/Logo-jiit%20(1).png?raw=true">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for the X icon and theme icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Enforced Dark Mode and Live Background */
        body {
            font-family: 'Inter', sans-serif;
            background: #0d111c;
            color: #d1d5db;
            transition: background-color 0.3s;
            
            /* Live Gradient Background Effect */
            background-image: linear-gradient(270deg, #0d111c, #1f2937, #0d111c, #1f2937);
            background-size: 400% 400%;
            animation: gradientMove 30s ease infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .subject-card {
            background-color: #1f2937; /* Darker card background */
            box-shadow: 0 4px 10px -2px rgba(255, 255, 255, 0.08), 0 2px 4px -2px rgba(255, 255, 255, 0.04);
            border: 1px solid #374151; /* Darker border */
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s;
        }
        .subject-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        }
        input {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #d1d5db !important;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            transition: background-color 0.3s, border-color 0.3s;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Custom glow effect for the icon (Red -> Orange -> Green Cycle) */
        .cross-glow {
            animation: color-cycle 4s infinite alternate, pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        @keyframes color-cycle {
            0%   { color: #ef4444; text-shadow: 0 0 8px #ef4444, 0 0 15px #f87171; } /* Red */
            50%  { color: #f97316; text-shadow: 0 0 8px #f97316, 0 0 15px #fb923c; } /* Orange */
            100% { color: #10b981; text-shadow: 0 0 8px #10b981, 0 0 15px #34d399; } /* Green */
        }

        /* Red Glow for Aditya Pandey's Logo */
        .red-glow {
            box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.5), 0 0 5px 2px rgba(239, 68, 68, 0.8) !important;
        }

        .tab-button.active {
            border-bottom: 2px solid #6366f1;
            background-color: #374151;
            color: #e0e7ff;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        
        <!-- Top Controls: Semester Select -->
        <div class="flex justify-start items-center mb-6">
            <div class="relative">
                <select id="sem-select" class="bg-gray-700 text-gray-200 border border-gray-600 rounded-lg p-2 text-sm shadow-md transition duration-300" onchange="alert('Semester selection feature is for future development. Only Semester 1 is available.'); this.value = 1;">
                    <option value="1" selected>Semester 1</option>
                    <option value="2" disabled>Semester 2 ðŸ”’</option>
                    <option value="3" disabled>Semester 3 ðŸ”’</option>
                    <option value="4" disabled>Semester 4 ðŸ”’</option>
                    <option value="5" disabled>Semester 5 ðŸ”’</option>
                    <option value="6" disabled>Semester 6 ðŸ”’</option>
                    <option value="7" disabled>Semester 7 ðŸ”’</option>
                    <option value="8" disabled>Semester 8 ðŸ”’</option>
                </select>
            </div>
        </div>

        <header class="text-center mb-10 p-6 bg-gray-800 rounded-xl shadow-2xl transition duration-300">
            
            <!-- Collaboration Banner -->
            <div class="flex items-center justify-center space-x-4 mb-6">
                <!-- Aditya Pandey Image with Red Glow -->
                <img 
                    src="https://github.com/Tech4Aditya/Virtual-Physics-Lab/blob/main/adityapandey.jpg?raw=true" 
                    alt="Aditya Pandey" 
                    class="red-glow h-16 w-16 md:h-20 md:w-20 rounded-full object-cover border-4 border-red-500 shadow-lg"
                    onerror="this.onerror=null; this.src='https://placehold.co/80x80/2563eb/ffffff?text=AP'"
                >
                
                <!-- Cross Icon with Color Cycle Glow -->
                <i class="fa-solid fa-xmark text-4xl cross-glow"></i>

                <!-- JIIT Logo -->
                <img 
                    src="https://github.com/Tech4Aditya/Virtual-Physics-Lab/blob/main/Logo-jiit%20(1).png?raw=true" 
                    alt="JIIT Noida Logo" 
                    class="h-16 w-16 md:h-20 md:w-20 object-contain rounded-full bg-white p-1 border-4 border-blue-500 shadow-lg"
                    onerror="this.onerror=null; this.src='https://placehold.co/80x80/1e3a8a/ffffff?text=JIIT'"
                >
            </div>
            
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-400">SGPA Score Estimator</h1>
            <p class="text-gray-400 mt-2 text-lg">Calculate your Semester Grade Point Average. (Credits vary per subject)</p>
        </header>

        <!-- Grade Scale Customization Panel -->
        <div class="mb-8">
            <button onclick="toggleGradeScalePanel()" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex justify-between items-center">
                <span>Grade Scale Manager (Define Scales A, B, C)</span>
                <span id="toggle-icon-panel">â–¼</span>
            </button>

            <div id="grade-scale-panel" class="mt-4 p-0 bg-gray-800 rounded-xl border border-indigo-700 hidden transition duration-300">
                <!-- Tabs for Scales -->
                <div class="flex border-b border-indigo-700">
                    <button class="tab-button active flex-1 p-3 text-sm font-semibold text-gray-300 rounded-tl-xl" data-scale-id="DEFAULT" onclick="showScale('DEFAULT')">Scale A (Default)</button>
                    <button class="tab-button flex-1 p-3 text-sm font-semibold text-gray-300" data-scale-id="ALT1" onclick="showScale('ALT1')">Scale B (Custom 1)</button>
                    <button class="tab-button flex-1 p-3 text-sm font-semibold text-gray-300 rounded-tr-xl" data-scale-id="ALT2" onclick="showScale('ALT2')">Scale C (Custom 2)</button>
                </div>

                <!-- Scale Content -->
                <div id="scale-content" class="p-6">
                    <p class="font-semibold text-gray-300 mb-4">Set Minimum Marks Required for Each Grade Point (Max 100):</p>
                    <div id="scale-inputs" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <!-- Inputs injected here -->
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button onclick="saveCurrentScaleName()" class="bg-gray-700 text-white font-medium py-2 px-4 rounded-md hover:bg-gray-600 transition duration-150 text-sm">
                            Save Scale Name
                        </button>
                        <button onclick="resetCurrentScale()" class="bg-red-500 text-white font-medium py-2 px-4 rounded-md hover:bg-red-600 transition duration-150 text-sm">
                            Reset Scale
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Cards Container -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10" id="subjects-container">
            <!-- Subject Cards will be injected here -->
        </div>

        <!-- SGPA Result Panel -->
        <div class="bg-gradient-to-r from-green-500 to-teal-600 p-6 rounded-xl shadow-2xl text-white text-center">
            <p class="text-xl font-semibold mb-2">Estimated SGPA</p>
            <div id="sgpa-result" class="text-6xl font-black">0.00</div>
            <p id="sgpa-summary" class="mt-3 text-lg font-medium">Enter your marks above to see your result.</p>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        const DEFAULT_GRADE_SCALE_CUTOFFS = {
            10: 80, 9: 70, 8: 65, 7: 60, 6: 55, 5: 50, 4: 40,
        };
        const SCALE_STORAGE_KEY = 'sgpaNamedGradeScales';
        const SUBJECT_SCALE_MAP_KEY = 'sgpaSubjectScaleMap';
        const MARKS_STORAGE_KEY = 'sgpaMarks_sem1'; 
        const SCALE_SLOTS = ['DEFAULT', 'ALT1', 'ALT2'];

        let namedGradeScales = {};
        let subjectScaleMap = {};
        let currentEditingScaleId = 'DEFAULT';

        // Global Constants - Refined structure to include distinct accent colors
        const SUBJECTS = [
            // Title Color (text-*) and Border Color (border-*) are used for clean accents
            { id: "sdf1", name: "SDF-1", credits: 4, components: [{ type: 'Midsem', max: 30, key: 'midsem' }, { type: 'Endsem', max: 40, key: 'endsem' }, { type: 'TA', max: 30, key: 'ta' }], titleColor: 'text-amber-400', borderColor: 'border-amber-400' }, 
            { id: "physics1", name: "Physics-1", credits: 4, components: [{ type: 'Midsem', max: 30, key: 'midsem' }, { type: 'Endsem', max: 40, key: 'endsem' }, { type: 'TA', max: 30, key: 'ta' }], titleColor: 'text-cyan-400', borderColor: 'border-cyan-400' }, 
            { id: "maths1", name: "Maths-1", credits: 4, components: [{ type: 'Midsem', max: 30, key: 'midsem' }, { type: 'Endsem', max: 40, key: 'endsem' }, { type: 'TA', max: 30, key: 'ta' }], titleColor: 'text-fuchsia-400', borderColor: 'border-fuchsia-400' }, 
            { id: "bel1", name: "BEL-1", credits: 4, components: [{ type: 'Midsem', max: 30, key: 'midsem' }, { type: 'Endsem', max: 40, key: 'endsem' }, { type: 'TA', max: 30, key: 'ta' }], titleColor: 'text-emerald-400', borderColor: 'border-emerald-400' }, 
            { id: "english", name: "English", credits: 1.5, components: [{ type: 'Midsem', max: 30, key: 'midsem' }, { type: 'Endsem', max: 40, key: 'endsem' }, { type: 'TA', max: 30, key: 'ta' }], titleColor: 'text-slate-400', borderColor: 'border-slate-500' }, 
            { id: "eddlab", name: "EDD Lab", credits: 1.5, components: [{ type: 'Midsem', max: 20, key: 'midsem' }, { type: 'Endsem', max: 20, key: 'endsem' }, { type: 'TA', max: 60, key: 'ta' }], titleColor: 'text-purple-400', borderColor: 'border-purple-400' }, 
            { id: "sdflab", name: "SDF LAB", credits: 1, components: [{ type: 'Midsem', max: 20, key: 'midsem' }, { type: 'Endsem', max: 20, key: 'endsem' }, { type: 'TA', max: 60, key: 'ta' }], titleColor: 'text-amber-500', borderColor: 'border-amber-500' }, 
            { id: "bellab", name: "BEL LAB", credits: 1, components: [{ type: 'Midsem', max: 20, key: 'midsem' }, { type: 'Endsem', max: 20, key: 'endsem' }, { type: 'TA', max: 60, key: 'ta' }], titleColor: 'text-emerald-500', borderColor: 'border-emerald-500' }, 
            { id: "physicslab", name: "Physics Lab", credits: 1, components: [{ type: 'Midsem', max: 20, key: 'midsem' }, { type: 'Endsem', max: 20, key: 'endsem' }, { type: 'TA', max: 60, key: 'ta' }], titleColor: 'text-cyan-500', borderColor: 'border-cyan-600' }
        ].map(sub => ({
            ...sub,
            subjectId: sub.name.toLowerCase().replace(/[^a-z0-9]/g, '') // Ensure subjectId is calculated
        }));


        // --- Data Persistence Logic (Marks) ---

        function loadMarks() {
            try {
                const storedMarks = localStorage.getItem(MARKS_STORAGE_KEY);
                return storedMarks ? JSON.parse(storedMarks) : {};
            } catch (e) {
                console.error("Could not load marks from storage.", e);
                return {};
            }
        }

        function saveMark(subjectId, componentKey, value) {
            try {
                const marks = loadMarks();
                if (!marks[subjectId]) {
                    marks[subjectId] = {};
                }
                marks[subjectId][componentKey] = value;
                localStorage.setItem(MARKS_STORAGE_KEY, JSON.stringify(marks));
            } catch (e) {
                console.error("Could not save mark to storage.", e);
            }
        }

        // --- Grade Scale Management Logic (Refactored) ---

        function getScaleDisplayName(scaleId) {
            switch(scaleId) {
                case 'DEFAULT': return 'Scale A (Default)';
                case 'ALT1': return 'Scale B (Custom 1)';
                case 'ALT2': return 'Scale C (Custom 2)';
                default: return 'Unknown';
            }
        }

        function loadAllScalesAndMaps() {
            try {
                const storedScales = localStorage.getItem(SCALE_STORAGE_KEY);
                if (storedScales) {
                    const loadedScales = JSON.parse(storedScales);
                    // Ensure loaded scales have correct structure (name and cutoffs)
                    SCALE_SLOTS.forEach(id => {
                        if (loadedScales[id]) {
                            namedGradeScales[id] = {
                                name: loadedScales[id].name || getScaleDisplayName(id),
                                cutoffs: loadedScales[id].cutoffs || loadedScales[id]
                            };
                        } else {
                             namedGradeScales[id] = { cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } };
                        }
                    });
                } else {
                    namedGradeScales = {
                        DEFAULT: { name: getScaleDisplayName('DEFAULT'), cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } },
                        ALT1: { name: getScaleDisplayName('ALT1'), cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } },
                        ALT2: { name: getScaleDisplayName('ALT2'), cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } }
                    };
                }

                const storedMap = localStorage.getItem(SUBJECT_SCALE_MAP_KEY);
                if (storedMap) {
                    subjectScaleMap = JSON.parse(storedMap);
                } else {
                    // Default all subjects to use the 'DEFAULT' scale
                    SUBJECTS.forEach(sub => { subjectScaleMap[sub.subjectId] = 'DEFAULT'; });
                }
                
                // Set tab names correctly on the UI
                SCALE_SLOTS.forEach(id => {
                    const scaleData = namedGradeScales[id];
                    if (scaleData && scaleData.name) {
                        const button = document.querySelector(`.tab-button[data-scale-id="${id}"]`);
                        if (button) button.textContent = scaleData.name;
                    }
                });

            } catch (e) {
                console.error("Could not load grade scales or map from storage.", e);
                // Reset to safe defaults if storage fails
                namedGradeScales = {
                    DEFAULT: { name: getScaleDisplayName('DEFAULT'), cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } },
                    ALT1: { name: getScaleDisplayName('ALT1'), cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } },
                    ALT2: { name: getScaleDisplayName('ALT2'), cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } }
                };
                SUBJECTS.forEach(sub => { subjectScaleMap[sub.subjectId] = 'DEFAULT'; });
            }
            showScale(currentEditingScaleId);
        }

        function saveNamedScales() {
            try {
                localStorage.setItem(SCALE_STORAGE_KEY, JSON.stringify(namedGradeScales));
            } catch (e) {
                console.error("Could not save named grade scales.", e);
            }
            calculateSGPA();
        }

        function saveSubjectScaleMap() {
            try {
                localStorage.setItem(SUBJECT_SCALE_MAP_KEY, JSON.stringify(subjectScaleMap));
            } catch (e) {
                console.error("Could not save subject scale map.", e);
            }
            calculateSGPA();
        }

        function showScale(scaleId) {
            currentEditingScaleId = scaleId;
            
            // Get cutoffs from the structured object
            const scaleData = namedGradeScales[scaleId] || {};
            const currentCutoffs = scaleData.cutoffs || DEFAULT_GRADE_SCALE_CUTOFFS;
            
            const scaleInputsEl = document.getElementById('scale-inputs');
            
            // Update Tab active state
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[data-scale-id="${scaleId}"]`).classList.add('active');

            let html = '';
            const points = Object.keys(DEFAULT_GRADE_SCALE_CUTOFFS).map(Number).sort((a, b) => b - a);

            points.forEach(point => {
                const gradeName = getGradeNameByPoint(point);
                if (point >= 4) {
                    html += `
                        <div>
                            <label for="grade-${point}" class="block text-xs font-medium text-gray-400 mb-1">Min. Marks for ${gradeName} (${point} Pts)</label>
                            <input 
                                type="number" 
                                data-point="${point}" 
                                class="w-full p-2 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm font-semibold text-center"
                                min="0" 
                                max="100" 
                                value="${currentCutoffs[point] || 0}"
                                oninput="updateCurrentScaleCutoff(${point}, this.value)"
                            />
                        </div>
                    `;
                }
            });
            scaleInputsEl.innerHTML = html;
        }

        function updateCurrentScaleCutoff(point, value) {
            let numValue = parseInt(value);
            if (isNaN(numValue) || numValue < 0) {
                numValue = 0;
            }
            if (numValue > 100) {
                numValue = 100;
            }
            
            // Ensure namedGradeScales[currentEditingScaleId] is properly initialized for cutoffs
            if (!namedGradeScales[currentEditingScaleId]) {
                namedGradeScales[currentEditingScaleId] = { cutoffs: { ...DEFAULT_GRADE_SCALE_CUTOFFS } };
            } else if (!namedGradeScales[currentEditingScaleId].cutoffs) {
                 namedGradeScales[currentEditingScaleId].cutoffs = { ...DEFAULT_GRADE_SCALE_CUTOFFS };
            }
            
            namedGradeScales[currentEditingScaleId].cutoffs[point] = numValue;
            saveNamedScales();
        }

        function resetCurrentScale() {
            namedGradeScales[currentEditingScaleId].cutoffs = { ...DEFAULT_GRADE_SCALE_CUTOFFS };
            // Also reset name
            namedGradeScales[currentEditingScaleId].name = getScaleDisplayName(currentEditingScaleId);
            const button = document.querySelector(`.tab-button[data-scale-id="${currentEditingScaleId}"]`);
            if (button) button.textContent = namedGradeScales[currentEditingScaleId].name;

            saveNamedScales();
            showScale(currentEditingScaleId);
            renderSubjectCards(); // Update dropdowns if name changed
        }
        
        function saveCurrentScaleName() {
            const currentName = (namedGradeScales[currentEditingScaleId] && namedGradeScales[currentEditingScaleId].name) || getScaleDisplayName(currentEditingScaleId);
            const newName = prompt(`Enter a new name for ${currentName}:`);
            if (newName && newName.trim()) {
                const button = document.querySelector(`.tab-button[data-scale-id="${currentEditingScaleId}"]`);
                if (button) button.textContent = newName.trim();
                
                // Initialize structure if needed, then save name
                if (!namedGradeScales[currentEditingScaleId]) {
                    namedGradeScales[currentEditingScaleId] = {};
                }
                namedGradeScales[currentEditingScaleId].name = newName.trim();
                saveNamedScales();
                // Re-render subject cards to update dropdown names
                renderSubjectCards();
            }
        }

        function toggleGradeScalePanel() {
            const panel = document.getElementById('grade-scale-panel');
            const icon = document.getElementById('toggle-icon-panel');
            const isHidden = panel.classList.contains('hidden');
            
            if (isHidden) {
                panel.classList.remove('hidden');
                icon.textContent = 'â–²';
            } else {
                panel.classList.add('hidden');
                icon.textContent = 'â–¼';
            }
        }
        
        function getGradeNameByPoint(point) {
            switch(point) {
                case 10: return "A+";
                case 9: return "A";
                case 8: return "B+";
                case 7: return "B";
                case 6: return "C+";
                case 5: return "C";
                case 4: return "D"; 
                default: return "N/A";
            }
        }

        /**
         * Determines the grade and grade point based on the total marks (out of 100).
         * Uses the specific scale assigned to the subject.
         */
        function calculateGradePoint(subjectId, marks) {
            const scaleId = subjectScaleMap[subjectId] || 'DEFAULT';
            
            let cutoffs = DEFAULT_GRADE_SCALE_CUTOFFS;
            if (namedGradeScales[scaleId]) {
                cutoffs = namedGradeScales[scaleId].cutoffs || namedGradeScales[scaleId];
            }
            
            const points = Object.keys(cutoffs).map(Number).sort((a, b) => b - a);

            for (const point of points) {
                if (marks >= (cutoffs[point] || 0)) {
                    return { grade: getGradeNameByPoint(point), points: point };
                }
            }
            return { grade: "F", points: 0 };
        }

        // --- Subject Rendering and Calculation Logic ---

        function renderSubjectCards() {
             const container = document.getElementById('subjects-container');
             // Ensure the container is defined before calling map
             if (!container) return; 

             // Map over the SUBJECTS array and render
             container.innerHTML = SUBJECTS.map((sub) => renderSingleSubjectCard(sub)).join('');
             
             // Re-attach input listeners
             const inputs = container.querySelectorAll('input[type="number"]');
             inputs.forEach(input => {
                input.addEventListener('change', calculateSGPA);
                input.addEventListener('blur', calculateSGPA); 
            });
            // Re-run calculation
            calculateSGPA();
        }

        function handleScaleChange(selectElement) {
            const subjectId = selectElement.getAttribute('data-subject-id');
            const newScaleId = selectElement.value;
            subjectScaleMap[subjectId] = newScaleId;
            saveSubjectScaleMap();
        }

        /**
         * Renders the input fields for a single subject card.
         */
        function renderSingleSubjectCard(subject) {
            // Check if subject is valid before proceeding
            if (!subject || !subject.subjectId) {
                console.error("Invalid subject data passed to renderSingleSubjectCard", subject);
                return '';
            }

            const id = subject.subjectId;
            const creditDisplay = subject.credits % 1 === 0 ? subject.credits : subject.credits.toFixed(1);
            const savedMarks = loadMarks()[id] || {};
            const currentScaleId = subjectScaleMap[id] || 'DEFAULT';

            const inputsHtml = subject.components.map(component => 
                renderInputField(id, component, savedMarks[component.key] || '')
            ).join('');

            // Options for scale selector
            const scaleOptions = SCALE_SLOTS.map(scaleId => {
                const scaleData = namedGradeScales[scaleId];
                const name = (scaleData && scaleData.name) || getScaleDisplayName(scaleId);
                return `<option value="${scaleId}" ${currentScaleId === scaleId ? 'selected' : ''}>${name}</option>`;
            }).join('');

            return `
                <div class="subject-card p-6 rounded-xl border-l-4 ${subject.borderColor}">
                    <div class="flex justify-between items-start mb-3">
                         <h2 class="text-xl font-bold ${subject.titleColor}">${subject.name} (${creditDisplay} Credits)</h2>
                         <select 
                            data-subject-id="${id}" 
                            onchange="handleScaleChange(this)"
                            class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md p-1 text-xs shadow-md"
                         >
                            ${scaleOptions}
                         </select>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        ${inputsHtml}
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-400">Total Marks: <span id="${id}-total" class="font-bold text-white">0</span> / 100</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400">Grade: <span id="${id}-grade" class="font-bold text-red-500">N/A</span></p>
                            <p class="text-sm text-gray-400">Points: <span id="${id}-points" class="font-bold text-white">0</span></p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders a single input field with constraints and loaded value.
         */
        function renderInputField(subjectId, component, savedValue) {
            const componentType = component.type.toLowerCase();
            const componentKey = component.key;
            const max = component.max;

            return `
                <div>
                    <label for="${subjectId}-${componentType}" class="block text-xs font-medium text-gray-400 mb-1">${component.type} (Max ${max})</label>
                    <input 
                        type="number" 
                        id="${subjectId}-${componentType}" 
                        data-max="${max}" 
                        data-subject-id="${subjectId}"
                        data-component-key="${componentKey}"
                        class="w-full p-2 border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm font-semibold text-center"
                        min="0" 
                        max="${max}" 
                        value="${savedValue}"
                        placeholder="0-${max}"
                        oninput="handleMarkInput(this); calculateSGPA();"
                    />
                </div>
            `;
        }
        
        /**
         * Handles input validation and saving mark to localStorage.
         */
        function handleMarkInput(input) {
            validateInput(input);
            
            const subjectId = input.getAttribute('data-subject-id');
            const componentKey = input.getAttribute('data-component-key');
            const value = input.value;

            if (value !== '') {
                saveMark(subjectId, componentKey, parseFloat(value));
            } else {
                saveMark(subjectId, componentKey, 0); 
            }
        }

        /**
         * Ensures input value does not exceed the data-max attribute.
         */
        function validateInput(input) {
            let value = parseFloat(input.value);
            const max = parseFloat(input.getAttribute('data-max'));

            if (isNaN(value) || value < 0) {
                value = 0; 
            }
            if (value > max) {
                value = max;
                input.value = max;
            }
            
            if (!isNaN(value)) {
                input.value = value;
            }
        }


        /**
         * Main calculation function: Calculates SGPA and updates the UI.
         */
        function calculateSGPA() {
            let totalWeightedPoints = 0;
            let totalCredits = 0;

            SUBJECTS.forEach((subject) => {
                const id = subject.subjectId;
                const credits = subject.credits;
                let totalMarks = 0;
                let isEntered = false;
                
                subject.components.forEach(component => {
                    const componentType = component.type.toLowerCase();
                    const inputEl = document.getElementById(`${id}-${componentType}`);
                    const mark = parseFloat(inputEl.value) || 0; 
                    totalMarks += mark;
                    
                    if (inputEl.value !== '') {
                        isEntered = true;
                    }
                });
                
                const totalEl = document.getElementById(`${id}-total`);
                const gradeEl = document.getElementById(`${id}-grade`);
                const pointsEl = document.getElementById(`${id}-points`);

                if (isEntered || totalMarks > 0) { 
                    
                    // Crucial change: calculate grade based on subject's assigned scale
                    const { grade, points } = calculateGradePoint(id, totalMarks);

                    // Update individual subject results
                    totalEl.textContent = totalMarks;
                    gradeEl.textContent = grade;
                    pointsEl.textContent = points;
                    
                    const gradeTextColor = points >= 7 ? 'text-green-400' : 
                                           points >= 4 ? 'text-yellow-400' : 'text-red-400';
                    gradeEl.className = `font-bold ${gradeTextColor}`;

                    totalWeightedPoints += credits * points;
                    totalCredits += credits;

                } else {
                    totalEl.textContent = '0';
                    gradeEl.textContent = 'N/A';
                    pointsEl.textContent = '0';
                    gradeEl.className = 'font-bold text-gray-400';
                }
            });

            const sgpaEl = document.getElementById('sgpa-result');
            const summaryEl = document.getElementById('sgpa-summary');

            let sgpa = 0.00;

            if (totalCredits > 0) {
                sgpa = totalWeightedPoints / totalCredits;
                sgpaEl.textContent = sgpa.toFixed(2);
                
                let message;
                if (sgpa >= 9.0) {
                    message = "Outstanding";
                } else if (sgpa >= 8.0) {
                    message = "Nice job";
                } else if (sgpa >= 7.0) {
                    message = "Good work, keep it up";
                } else if (sgpa >= 6.0) {
                    message = "can do better, sincere efforts required";
                } else if (sgpa >= 4.0) {
                    message = "need to do hardwork";
                } else {
                    message = "bad result, focus on studies";
                }
                summaryEl.textContent = message;

            } else {
                sgpaEl.textContent = '0.00';
                summaryEl.textContent = 'Enter your marks above to see your result.';
            }
        }

        /**
         * Initialize the application: render cards and attach event listeners.
         */
        function initializeApp() {
            // 1. Load all scales and the subject map
            loadAllScalesAndMaps(); 
            
            // 2. Render subject cards (this now loads marks from storage)
            renderSubjectCards();
        }

        // Run the initialization function when the window loads
        window.onload = initializeApp;

    </script>

</body>
</html>
